###########
# Builder #
###########
FROM node:20-alpine AS builder
ENV PNPM_HOME=/root/.local/share/pnpm
ENV PATH=$PNPM_HOME:$PATH
RUN corepack enable

WORKDIR /repo

COPY pnpm-lock.yaml pnpm-workspace.yaml package.json tsconfig.base.json ./

RUN mkdir -p packages/bus packages/config packages/db packages/logger packages/messaging packages/recipes packages/redis packages/shared-kernel packages/utils
COPY packages/bus/package.json ./packages/bus/
COPY packages/config/package.json ./packages/config/
COPY packages/db/package.json ./packages/db/
COPY packages/logger/package.json ./packages/logger/
COPY packages/messaging/package.json ./packages/messaging/
COPY packages/recipes/package.json ./packages/recipes/
COPY packages/redis/package.json ./packages/redis/
COPY packages/shared-kernel/package.json ./packages/shared-kernel/
COPY packages/utils/package.json ./packages/utils/
COPY apps/inventory-svc/package.json ./apps/inventory-svc/

RUN pnpm -w install
RUN pnpm install

COPY packages ./packages
COPY apps/inventory-svc ./apps/inventory-svc

RUN pnpm run build:shared
RUN pnpm -F inventory-svc run build

RUN pnpm deploy --legacy --filter inventory-svc --prod /opt/app

##########
# Runner #
##########
FROM node:20-alpine AS runner
ENV NODE_ENV=production
WORKDIR /app

COPY --from=builder /opt/app ./

RUN echo '#!/bin/sh' > /entrypoint.sh && \
    echo 'echo "Running database migrations..."' >> /entrypoint.sh && \
    echo 'node dist/migrate.js' >> /entrypoint.sh && \
    echo 'echo "Starting inventory service..."' >> /entrypoint.sh && \
    echo 'exec "$@"' >> /entrypoint.sh && \
    chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
CMD ["node", "dist/index.js"]
